name: deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment environment
        required: true
        default: production
        type: choice
        options:
          - production
          - staging
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  APP_NAME: anvilkit-auth-template

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta_auth.outputs.version }}
      image_owner: ${{ steps.prep.outputs.owner_lc }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare image owner
        id: prep
        run: echo "owner_lc=${GITHUB_REPOSITORY_OWNER,,}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate auth-api metadata
        id: meta_auth
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.prep.outputs.owner_lc }}/${{ env.APP_NAME }}-auth-api
          tags: |
            type=ref,event=tag
            type=sha,prefix=sha-

      - name: Validate production compose config
        env:
          IMAGE_OWNER: ${{ steps.prep.outputs.owner_lc }}
          IMAGE_TAG: ${{ github.sha }}
        run: docker compose --env-file .env.example -f deploy/docker-compose.prod.yml config > /dev/null

      - name: Build and push auth-api image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/auth-api/Dockerfile
          push: true
          tags: ${{ steps.meta_auth.outputs.tags }}
          labels: ${{ steps.meta_auth.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate admin-api metadata
        id: meta_admin
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.prep.outputs.owner_lc }}/${{ env.APP_NAME }}-admin-api
          tags: |
            type=ref,event=tag
            type=sha,prefix=sha-

      - name: Build and push admin-api image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/admin-api/Dockerfile
          push: true
          tags: ${{ steps.meta_admin.outputs.tags }}
          labels: ${{ steps.meta_admin.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH key
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' '${{ secrets.DEPLOY_SSH_KEY }}' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Upload deployment assets
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          port="${DEPLOY_PORT:-22}"
          ssh -p "$port" -o StrictHostKeyChecking=accept-new "$DEPLOY_USER@$DEPLOY_HOST" \
            "mkdir -p '$DEPLOY_PATH/deploy' '$DEPLOY_PATH/scripts' '$DEPLOY_PATH/services/auth-api/migrations'"

          scp -P "$port" -o StrictHostKeyChecking=accept-new deploy/docker-compose.prod.yml \
            "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/deploy/docker-compose.prod.yml"
          scp -P "$port" -o StrictHostKeyChecking=accept-new scripts/remote_deploy.sh \
            "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/scripts/remote_deploy.sh"
          scp -P "$port" -o StrictHostKeyChecking=accept-new services/auth-api/migrations/001_init.sql \
            "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/services/auth-api/migrations/001_init.sql"

      - name: Run remote deployment
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
          IMAGE_OWNER: ${{ needs.build.outputs.image_owner }}
          USE_INTERNAL_DEPS: ${{ vars.USE_INTERNAL_DEPS }}
        run: |
          port="${DEPLOY_PORT:-22}"
          deps="${USE_INTERNAL_DEPS:-true}"
          ssh -p "$port" -o StrictHostKeyChecking=accept-new "$DEPLOY_USER@$DEPLOY_HOST" \
            "chmod +x '$DEPLOY_PATH/scripts/remote_deploy.sh' && \
             '$DEPLOY_PATH/scripts/remote_deploy.sh' '$DEPLOY_PATH' '$IMAGE_TAG' '$IMAGE_OWNER' '$deps'"
