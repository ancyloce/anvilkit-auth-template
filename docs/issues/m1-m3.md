# GitHub Milestones & Issues（M1-M3）

> 本文可直接用于：
> 1) 手动在 GitHub 创建 Milestone + Issue；
> 2) 粘贴到你们内部批量创建工具。
>
> 约定 labels：
> - `milestone:1` / `milestone:2` / `milestone:3`
> - `area:auth` / `area:tenant` / `area:rbac`
> - `type:feature` / `type:chore` / `type:test` / `type:ci`
> - `priority:p0` / `priority:p1`
> - `service:auth-api` / `service:admin-api`

---

## Milestones（最佳实践建议）

### Milestone 1: AuthN 核心
- **Title**: `M1 - AuthN Core`
- **Description**: 完成注册、登录、刷新、登出、JWT 中间件、测试与 CI gating，形成可上线的认证最小闭环。
- **Success Criteria**:
  - auth-api 提供完整 AuthN 接口与刷新轮换机制
  - 关键路径（register/login/refresh/logout）具备稳定单测
  - CI 测试失败时阻断部署

### Milestone 2: 多租户最小闭环
- **Title**: `M2 - Multi-tenant MVP`
- **Description**: 引入租户数据模型、Bootstrap、租户切换与成员管理基础能力。
- **Success Criteria**:
  - 支持用户与多个 tenant 关联
  - access token 支持 `tid` claim
  - admin-api 提供成员管理基础接口

### Milestone 3: RBAC（Casbin Domain=tid）
- **Title**: `M3 - RBAC with Casbin`
- **Description**: 完成基于租户域（tid）的 Casbin 鉴权，覆盖默认策略、角色映射、中间件与测试。
- **Success Criteria**:
  - admin-api 可基于 `uid/tid/role` enforce
  - owner/admin/member 权限行为符合预期
  - 关键 RBAC 用例纳入 CI

---

## Milestone 1 — AuthN 核心

### Issue: M1-01 统一 Auth 配置与密码/Token 工具
**Labels**: `milestone:1, area:auth, type:chore, priority:p0, service:auth-api`

#### Checklist
- [ ] 增加 auth 配置结构体（env -> config），集中管理 JWT/TTL/密码策略/限流阈值
- [ ] 实现密码 hash 工具：bcrypt（cost 可配置）
- [ ] 实现 refresh token 工具：生成随机 opaque token（base64url），并提供 sha256 hash（hex）
- [ ] 增加最小文档：README 里列出新增 env 变量

#### 验收标准
- [ ] 启动时缺失关键配置能报清晰错误（不打印敏感值）
- [ ] 提供 `HashPassword` / `VerifyPassword` / `GenRefreshToken` / `HashRefreshToken` 可被 handler/store 复用
- [ ] `go test ./...` 通过（如新增单测）

---

### Issue: M1-02 新增 AuthN 核心数据表 migration
**Labels**: `milestone:1, area:auth, type:feature, priority:p0, service:auth-api`

#### 表结构变更
- 新增 `services/auth-api/migrations/002_authn_core.sql`
- `users`
- `user_password_credentials`
- `refresh_sessions`

#### Checklist
- [ ] 编写 migration（幂等：`IF NOT EXISTS`）
- [ ] `refresh_sessions.token_hash` 设为 `UNIQUE`
- [ ] `refresh_sessions` 支持 rotation 字段：`revoked_at`、`replaced_by`
- [ ] 更新 migrate 资产上传/运行逻辑（如生产依赖此文件）

#### 验收标准
- [ ] migration 可重复执行不报错
- [ ] refresh session 可通过 `token_hash` 唯一定位
- [ ] 生产部署 migrate 能成功执行该 migration

---

### Issue: M1-03 实现注册接口（email + password）
**Labels**: `milestone:1, area:auth, type:feature, priority:p0, service:auth-api`

#### 接口清单
- `POST /v1/auth/register`
- req: `{ "email": "...", "password": "..." }`
- resp: `{ "user": { "id": "...", "email": "..." } }`（按统一 Envelope）

#### Checklist
- [ ] 校验 email 格式与 password 最小长度（配置化）
- [ ] 创建 user + password credential（hash 入库）
- [ ] email 冲突返回统一错误码（409 conflict）
- [ ] 更新 Postman collection：register

#### 验收标准
- [ ] 注册成功返回 201（或模板约定的成功码），且不返回敏感字段
- [ ] 重复 email 返回 conflict
- [ ] 单测覆盖：成功 / 重复 email / 弱密码

---

### Issue: M1-04 实现登录接口（password login + Redis 限流）
**Labels**: `milestone:1, area:auth, type:feature, priority:p0, service:auth-api`

#### 接口清单
- `POST /v1/auth/login`
- req: `{ "email": "...", "password": "..." }`
- resp: `{ access_token, expires_in, refresh_token, refresh_expires_in, user }`

#### Checklist
- [ ] 校验账号存在、密码正确、用户状态 active
- [ ] Redis 登录失败限流：`login_fail:{ip}:{email}`，5 次/10 分钟（可配置）
- [ ] 登录成功创建 `refresh_sessions`（存 `token_hash`）
- [ ] 生成 access jwt（`iss/aud/exp/iat/sub=uid`）
- [ ] 更新 Postman collection：login

#### 验收标准
- [ ] 登录成功返回 access+refresh（refresh 为 opaque，DB 只存 hash）
- [ ] 密码错/用户不存在返回 unauthorized（不泄露用户存在性更佳）
- [ ] 超过限流阈值返回 too_many_requests（429 或模板约定）
- [ ] 单测覆盖：成功 / 密码错 / 不存在 / 触发限流

---

### Issue: M1-05 实现 refresh（rotation + 旧 token 失效）
**Labels**: `milestone:1, area:auth, type:feature, priority:p0, service:auth-api`

#### 接口清单
- `POST /v1/auth/refresh`
- req: `{ "refresh_token": "<opaque>" }`
- resp: `{ access_token, expires_in, refresh_token, refresh_expires_in }`

#### Checklist
- [ ] 根据 `sha256(refresh_token)` 查询 session
- [ ] 校验：未过期、未 revoked
- [ ] rotation：创建新 session；旧 session `revoked_at=now()`，`replaced_by=new_session_id`
- [ ] 重放（旧 refresh 再用）必须失败
- [ ] 更新 Postman collection：refresh

#### 验收标准
- [ ] refresh 成功后旧 refresh 再用返回 unauthorized（明确错误码：`token_reused` / `session_revoked`）
- [ ] 过期 refresh 返回 unauthorized
- [ ] 单测覆盖：正常刷新 / 重放失败 / 过期失败 / revoked 失败

---

### Issue: M1-06 实现 logout（单设备）与 logout_all（可选）
**Labels**: `milestone:1, area:auth, type:feature, priority:p1, service:auth-api`

#### 接口清单
- `POST /v1/auth/logout`
- req: `{ "refresh_token": "<opaque>" }`
- `POST /v1/auth/logout_all`（可选）
- req: `{}`
- auth: access token（`sub=uid`）

#### Checklist
- [ ] logout：找到 session 并 `revoked_at=now()`
- [ ] logout_all：批量 revoke 用户所有未 revoked session
- [ ] 更新 Postman collection：logout（至少单设备）

#### 验收标准
- [ ] logout 后 refresh 必失败
- [ ] logout_all 后任意 refresh 必失败（如实现）
- [ ] 单测覆盖：logout 生效 / logout_all 生效（如实现）

---

### Issue: M1-07 Gin middleware：解析 JWT 并写入 uid（为后续 admin-api 铺垫）
**Labels**: `milestone:1, area:auth, type:chore, priority:p1, service:auth-api, service:admin-api`

#### Checklist
- [ ] 统一 JWT claims：`iss/aud/sub(uid)/exp/iat`
- [ ] auth middleware 从 `Authorization: Bearer` 解析 uid 写入 context（沿用 common-go 的 `httpx/ginmid`）
- [ ] 保持 Envelope + AppError 风格一致

#### 验收标准
- [ ] 任意需要登录的接口能从 context 取 uid
- [ ] 无 token/非法 token 返回统一 unauthorized

---

### Issue: M1-08 AuthN 单元测试与测试基建（pg+redis）
**Labels**: `milestone:1, area:auth, type:test, priority:p0, service:auth-api`

#### Checklist
- [ ] 添加测试 helper：读取 `TEST_DB_DSN`、`TEST_REDIS_ADDR`、`JWT_SECRET`
- [ ] 测试启动前自动执行 migrations（至少 `001 + 002`）
- [ ] 每个 test suite 清理数据（truncate 或独立 schema）
- [ ] handler 级测试（`httptest + gin`）覆盖 register/login/refresh/logout
- [ ] store 层测试（可选）覆盖 refresh rotation / revoke

#### 验收标准
- [ ] `go test ./services/auth-api/...` 稳定通过
- [ ] 覆盖：注册成功/冲突、登录成功/失败/限流、refresh 轮换+重放失败、logout 使 refresh 失效

---

### Issue: M1-09 CI：测试不通过禁止部署
**Labels**: `milestone:1, type:ci, priority:p0`

#### Checklist
- [ ] CI workflow 增加 test job：启动 postgres+redis service，设置 `TEST_*` env，运行 `go test`
- [ ] deploy workflow 增加 `needs: [test]` 且 `if: needs.test.result == 'success'`
- [ ] （可选）加分支保护建议：main 必须 CI 绿才能合并

#### 验收标准
- [ ] CI 中测试失败时 deploy job 不会运行
- [ ] CI 通过时可继续部署

---

## Milestone 2 — 多租户最小闭环

### Issue: M2-01 多租户表结构（tenants + tenant_users）
**Labels**: `milestone:2, area:tenant, type:feature, priority:p0, service:auth-api`

#### 表结构变更
- 新增 `services/auth-api/migrations/003_multitenant.sql`
- `tenants`
- `tenant_users(tenant_id,user_id,role)`

#### Checklist
- [ ] 编写 migration（幂等）
- [ ] role 字段支持 `owner/admin/member`（先字符串即可）
- [ ] 更新 README：多租户相关表说明

#### 验收标准
- [ ] 一个 user 可关联多个 tenant
- [ ] `tenant_users` 主键 `(tenant_id, user_id)` 生效

---

### Issue: M2-02 Bootstrap：创建 tenant + 首个 owner
**Labels**: `milestone:2, area:tenant, type:feature, priority:p0, service:admin-api`

#### 接口清单
- `POST /v1/bootstrap`
- req: `{ tenant_name, owner_email, owner_password }`
- resp: `{ tenant, owner_user }`

#### Checklist
- [ ] 创建 tenant、创建用户、建立 `tenant_users(owner)`
- [ ] 对重复 bootstrap 提供明确错误（或只允许一次）
- [ ] Postman collection 增加 bootstrap

#### 验收标准
- [ ] bootstrap 后可用 owner 登录，并能获取 `tid`（见 M2-03）
- [ ] 单测覆盖（至少 handler happy path）

---

### Issue: M2-03 Token 增加 tid claim + 租户切换接口
**Labels**: `milestone:2, area:tenant, type:feature, priority:p0, service:auth-api`

#### 接口清单
- `POST /v1/auth/switch_tenant`
- auth: access token（uid）
- req: `{ tenant_id }`
- resp: `{ access_token, expires_in }`（含 tid claim）

#### Checklist
- [ ] 校验用户属于 tenant
- [ ] 生成包含 `tid` 的 access token
- [ ] middleware 可从 token 解析 `tid` 写入 context（`tid` 可为空）

#### 验收标准
- [ ] 切换成功后访问 admin-api 可携带 tid
- [ ] 不属于该租户切换返回 forbidden/unauthorized（按模板约定）

---

### Issue: M2-04 租户成员管理接口（admin-api）
**Labels**: `milestone:2, area:tenant, type:feature, priority:p1, service:admin-api`

#### 接口清单
- `GET /v1/admin/tenants/{tid}/members`
- `POST /v1/admin/tenants/{tid}/members`
- `PATCH /v1/admin/tenants/{tid}/members/{uid}`
- `DELETE /v1/admin/tenants/{tid}/members/{uid}`

#### Checklist
- [ ] 最小实现：owner/admin 可管理；member 不可（先可硬编码，里程碑3再 casbin）
- [ ] 更新 Postman collection（可选）

#### 验收标准
- [ ] 成员增删改查可用
- [ ] 无权限访问返回统一 forbidden

---

## Milestone 3 — RBAC（Casbin domain=tid）

### Issue: M3-01 Casbin 适配与 casbin_rule 表（admin-api）
**Labels**: `milestone:3, area:rbac, type:feature, priority:p0, service:admin-api`

#### 表结构变更
- admin-api migration：`casbin_rule`（或复用现有方式）

#### Checklist
- [ ] 新增 `casbin_rule` 表 migration（幂等）
- [ ] admin-api 启动加载 casbin adapter（pgsql）
- [ ] 定义 casbin model（`domain=tid`）

#### 验收标准
- [ ] admin-api 启动不报错，能读写策略
- [ ] enforce 可基于 tid 进行判定

---

### Issue: M3-02 默认策略与租户角色映射（seed）
**Labels**: `milestone:3, area:rbac, type:feature, priority:p0, service:admin-api`

#### Checklist
- [ ] 定义角色：`tenant_owner` / `tenant_admin` / `member`
- [ ] 定义资源：后台路由（`/v1/admin/*`）
- [ ] 写入默认 policy（seed 或启动时初始化）
- [ ] `tenant_users.role -> casbin role` 映射规则

#### 验收标准
- [ ] owner/admin 可访问 admin 管理接口
- [ ] member 访问被拒绝（统一 forbidden）

---

### Issue: M3-03 admin-api 鉴权中间件（JWT uid/tid + casbin enforce）
**Labels**: `milestone:3, area:rbac, type:feature, priority:p0, service:admin-api`

#### Checklist
- [ ] 从 JWT claims 解析 `uid/tid`
- [ ] 查询 `tenant_users` 获取 role（可加 Redis cache）
- [ ] casbin enforce（`domain=tid, sub=role, obj=route, act=method/action`）
- [ ] 返回统一错误 Envelope（forbidden）

#### 验收标准
- [ ] 未登录 -> unauthorized
- [ ] 登录但无权限 -> forbidden
- [ ] 有权限 -> 正常访问

---

### Issue: M3-04 RBAC 单元测试
**Labels**: `milestone:3, area:rbac, type:test, priority:p1, service:admin-api`

#### Checklist
- [ ] 中间件测试：owner allow / member deny
- [ ] policy seed 测试（可选）
- [ ] CI 集成：`go test` 覆盖 admin-api 相关包

#### 验收标准
- [ ] `go test ./services/admin-api/...` 通过
- [ ] 关键权限用例被覆盖
